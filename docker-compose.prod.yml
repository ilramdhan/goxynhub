version: "3.9"

services:
  # Backend API
  backend:
    build:
      context: ./apps/backend
      dockerfile: Dockerfile
    container_name: landing-cms-backend
    restart: always
    expose:
      - "8080"
    environment:
      - APP_ENV=production
      - APP_PORT=8080
      - APP_DEBUG=false
      - DATABASE_URL=${DATABASE_URL}
      - JWT_ACCESS_SECRET=${JWT_ACCESS_SECRET}
      - JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
      - JWT_ACCESS_EXPIRY=15m
      - JWT_REFRESH_EXPIRY=168h
      - CORS_ORIGINS=${FRONTEND_URL}
      - CORS_ALLOW_CREDENTIALS=true
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - SUPABASE_STORAGE_BUCKET=media
      - LOG_LEVEL=info
      - LOG_FORMAT=json
      - COOKIE_DOMAIN=${COOKIE_DOMAIN}
      - COOKIE_SECURE=true
      - COOKIE_SAME_SITE=strict
      - RATE_LIMIT_ENABLED=true
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - landing-cms-network

  # Frontend
  frontend:
    build:
      context: ./apps/frontend
      dockerfile: Dockerfile
    container_name: landing-cms-frontend
    restart: always
    expose:
      - "3000"
    environment:
      - NEXT_PUBLIC_API_URL=${API_URL}
      - NEXT_PUBLIC_SITE_URL=${FRONTEND_URL}
      - NEXT_PUBLIC_DEFAULT_SITE_ID=${DEFAULT_SITE_ID}
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - landing-cms-network

  # Nginx reverse proxy
  nginx:
    image: nginx:alpine
    container_name: landing-cms-nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - backend
      - frontend
    networks:
      - landing-cms-network

networks:
  landing-cms-network:
    driver: bridge
